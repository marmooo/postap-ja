const playPanel=document.getElementById("playPanel"),infoPanel=document.getElementById("infoPanel"),countPanel=document.getElementById("countPanel"),scorePanel=document.getElementById("scorePanel"),japanese=document.getElementById("japanese"),gameTime=120;let gameTimer;const bgm=new Audio("mp3/bgm.mp3");bgm.volume=.1,bgm.loop=!0;let solvedCount=0,problemCount=0,correctCount=0,incorrectCount=0,targetProblems=[],problems=[];const audioContext=new AudioContext,audioBufferCache={};loadAudio("end","mp3/end.mp3"),loadAudio("correct","mp3/correct3.mp3"),loadAudio("incorrect","mp3/cat.mp3"),loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark"),localStorage.getItem("bgm")!=1&&(document.getElementById("bgmOn").classList.add("d-none"),document.getElementById("bgmOff").classList.remove("d-none"))}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function toggleBGM(){localStorage.getItem("bgm")==1?(document.getElementById("bgmOn").classList.add("d-none"),document.getElementById("bgmOff").classList.remove("d-none"),localStorage.setItem("bgm",0),bgm.pause()):(document.getElementById("bgmOn").classList.remove("d-none"),document.getElementById("bgmOff").classList.add("d-none"),localStorage.setItem("bgm",1),bgm.play())}async function playAudio(e,t){const s=await loadAudio(e,audioBufferCache[e]),n=audioContext.createBufferSource();if(n.buffer=s,t){const e=audioContext.createGain();e.gain.value=t,e.connect(audioContext.destination),n.connect(e),n.start()}else n.connect(audioContext.destination),n.start()}async function loadAudio(e,t){if(audioBufferCache[e])return audioBufferCache[e];const s=await fetch(t),o=await s.arrayBuffer(),n=await audioContext.decodeAudioData(o);return audioBufferCache[e]=n,n}function unlockAudio(){audioContext.resume()}async function loadProblems(){const e=await fetch(`problems.json`),t=await e.json();problems=t,changeCourse()}function nextProblem(){solvedCount=0,setProblem()}function getRandomInt(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e}function kanaToHira(e){return e.replace(/[\u30a1-\u30f6]/g,e=>{const t=e.charCodeAt(0)-96;return String.fromCharCode(t)})}function getFuriganaHTML(e){let t="";const n=getFuriganas(e);return n?n.forEach(e=>{e[1]?t+=`<ruby>${e[0]}<rt>${e[1]}</rt></ruby>`:t+=`<span>${e[0]}</span>`}):t+=`<span>${e.surface}</span>`,t}function getFuriganas(e){const n=e.reading;if(!n)return void 0;const t=e.surface;if(t==n)return void 0;const s=kanaToHira(t),o=kanaToHira(n);if(s==o)return void 0;const a=s.replaceAll(/[一-龠々ヵヶ]+/g,"([ぁ-ん]+)"),r=new RegExp(a),c=o.match(r).slice(1),i=new Map,l=t.match(/([一-龠々ヵヶ]+)/g);l.forEach((e,t)=>{i.set(e,c[t])});const d=t.split(/([一-龠々ヵヶ]+)/g).filter(e=>e!=""),u=d.map(e=>{const t=i.get(e);return t?[e,t]:[e,void 0]});return u}function mergePOS(e){const t=document.getElementById("gradeOption");return t.selectedIndex!=2&&(e=mergeAdjectiveVerbs(e)),t.selectedIndex==0&&(e=mergeAuxiliaryVerbs(e)),e}function mergeAuxiliaryVerbs(e){const t=[];let n=!1;return e.forEach((s,o)=>{const i=e[o+1];if(s.feature=="動詞"&&i&&i.feature=="助動詞"){n=!0;const e={feature:"動詞",surface:s.surface+i.surface,reading:s.reading+i.reading,featureDetails:s.featureDetails,conjugationForms:s.conjugationForms};t.push(e)}else n?n=!1:t.push(s)}),t}function mergeAdjectiveVerbs(e){const t=[];let n=!1;return e.forEach((s,o)=>{const i=e[o+1];if(s.featureDetails[0]=="形容動詞語幹"&&i&&i.feature=="助動詞"){n=!0;const e={feature:"形容動詞",surface:s.surface+i.surface,reading:s.surface+i.reading,featureDetails:["*","*","*"],conjugationForms:i.conjugationForms};t.push(e)}else n?n=!1:t.push(s)}),t}function setSearchingChoice(e,t,n){n.className="btn btn-light btn-lg m-1 px-2 choice";const o=document.createElement("div"),i=getFuriganaHTML(t),a=(new DOMParser).parseFromString(i,"text/html"),r=[...a.body.childNodes];o.replaceChildren(...r);const s=document.createElement("button");s.textContent=e+"？",s.className="btn btn-sm btn-primary",s.dataset.answer=t.feature,s.onclick=()=>{e==t.feature?(correctCount+=1,n.classList.add("border","border-primary"),s.textContent=e,playAudio("correct",.3),solvedCount+=1,problemCount<=solvedCount&&nextProblem()):(incorrectCount+=1,n.classList.add("bg-danger"),s.textContent=t.feature,playAudio("incorrect",.3)),s.disabled=!0},n.appendChild(o),n.appendChild(s)}function changeCourse(){const e=document.getElementById("courseOption"),n=e.options[e.selectedIndex],t=n.value;changeGradeByPOS(t),setProblemCache(t)}function changeGradeByPOS(e){switch(e){case"形容動詞":case"連体詞":case"感動詞":case"助動詞":case"接頭詞":{const e=document.getElementById("gradeOption");e.selectedIndex==0&&(e.selectedIndex=1)}}}function setProblemCache(e){e=="形容動詞"?targetProblems=problems.filter(e=>e.find((t,n)=>{const s=e[n+1];if(t.featureDetails[0]=="形容動詞語幹"&&s&&s.feature=="助動詞")return!0})):targetProblems=problems.filter(t=>t.find(t=>t.feature==e))}function setProblem(){const n=document.getElementById("courseOption"),i=n.options[n.selectedIndex],e=i.value;document.getElementById("explanation").textContent=`${e}を選んでください`;let t=targetProblems[getRandomInt(0,targetProblems.length)];t=mergePOS(t);const s=[];let o=0;t.forEach(t=>{const n=document.createElement("div");switch(t.feature){case"フィラー":case"間投詞":case"記号":n.className="btn btn-light btn-lg m-1 px-2",n.textContent=t.surface;break;default:setSearchingChoice(e,t,n),e==t.feature&&(o+=1)}s.push(n)}),problemCount=o,japanese.replaceChildren(...s)}function countdown(){correctCount=incorrectCount=0,countPanel.classList.remove("d-none"),infoPanel.classList.add("d-none"),playPanel.classList.add("d-none"),scorePanel.classList.add("d-none"),counter.textContent=3;const e=setInterval(()=>{const t=document.getElementById("counter"),n=["skyblue","greenyellow","violet","tomato"];if(parseInt(t.textContent)>1){const e=parseInt(t.textContent)-1;t.style.backgroundColor=n[e],t.textContent=e}else clearInterval(e),countPanel.classList.add("d-none"),infoPanel.classList.remove("d-none"),playPanel.classList.remove("d-none"),setProblem(),startGameTimer(),localStorage.getItem("bgm")==1&&bgm.play()},1e3)}function startGame(){clearInterval(gameTimer),initTime(),countdown()}function startGameTimer(){const e=document.getElementById("time");gameTimer=setInterval(()=>{const t=parseInt(e.textContent);t>0?e.textContent=t-1:(clearInterval(gameTimer),bgm.pause(),playAudio("end"),playPanel.classList.add("d-none"),scorePanel.classList.remove("d-none"),scoring())},1e3)}function initTime(){document.getElementById("time").textContent=gameTime}function scoring(){document.getElementById("score").textContent=correctCount,document.getElementById("count").textContent=correctCount+incorrectCount}function showAnswer(){const e=document.getElementById("courseOption"),t=e.options[e.selectedIndex],n=t.value,s=[...japanese.children];s.forEach(e=>{if(!e.classList.contains("choice"))return!1;const t=e.querySelector("button"),s=t.dataset.answer;t.disabled=!0,t.textContent=s,n==s?e.classList.add("bg-danger"):e.classList.remove("bg-danger")}),answerButton.disabled=!0,setTimeout(()=>{answerButton.disabled=!1,nextProblem()},5e3)}loadProblems(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("toggleBGM").onclick=toggleBGM,document.getElementById("courseOption").onchange=changeCourse,document.getElementById("startButton").onclick=startGame,document.getElementById("restartButton").onclick=startGame,document.getElementById("answerButton").onclick=showAnswer,document.addEventListener("click",unlockAudio,{once:!0,useCapture:!0})